<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="460px" preserveAspectRatio="none" style="width:766px;height:460px;background:#FFFFFF;" version="1.1" viewBox="0 0 766 460" width="766px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="308.1953" style="stroke:#181818;stroke-width:1.0;" width="10" x="401.5" y="127.6953"/><rect fill="#DFFF00" height="252.9297" style="stroke:#181818;stroke-width:1.0;" width="10" x="406.5" y="182.9609"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="110" x2="110" y1="36.2969" y2="453.8906"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="202" x2="202" y1="36.2969" y2="453.8906"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="406" x2="406" y1="36.2969" y2="453.8906"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="54" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="61" y="24.9951">TrustedClient</text><rect fill="#D3D3D3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="53" x="176" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="183" y="24.9951">UApp</text><rect fill="#87CEFA" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="51" x="381" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="388" y="24.9951">Eapp</text><rect fill="#FFFFFF" height="308.1953" style="stroke:#181818;stroke-width:1.0;" width="10" x="401.5" y="127.6953"/><rect fill="#DFFF00" height="252.9297" style="stroke:#181818;stroke-width:1.0;" width="10" x="406.5" y="182.9609"/><line style="stroke:#181818;stroke-width:1.0;" x1="406.5" x2="448.5" y1="67.4297" y2="67.4297"/><line style="stroke:#181818;stroke-width:1.0;" x1="448.5" x2="448.5" y1="67.4297" y2="80.4297"/><line style="stroke:#181818;stroke-width:1.0;" x1="407.5" x2="448.5" y1="80.4297" y2="80.4297"/><polygon fill="#181818" points="417.5,76.4297,407.5,80.4297,417.5,84.4297,413.5,80.4297" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="413.5" y="62.3638">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="426.5" y="62.3638">ocall_wait_for_request(req)</text><polygon fill="#181818" points="389.5,123.6953,399.5,127.6953,389.5,131.6953,393.5,127.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="110" x2="395.5" y1="127.6953" y2="127.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="117" y="122.6294">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="130" y="122.6294">request(gen_keys)</text><path d="M16,93.4297 L16,148.4297 L105,148.4297 L105,103.4297 L95,93.4297 L16,93.4297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M95,93.4297 L95,103.4297 L105,103.4297 L95,93.4297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="22" y="110.4966">Request:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="34" y="125.6294">key type</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="40" x="34" y="140.7622">secret</text><line style="stroke:#181818;stroke-width:1.0;" x1="411.5" x2="458.5" y1="169.9609" y2="169.9609"/><line style="stroke:#181818;stroke-width:1.0;" x1="458.5" x2="458.5" y1="169.9609" y2="182.9609"/><line style="stroke:#181818;stroke-width:1.0;" x1="417.5" x2="458.5" y1="182.9609" y2="182.9609"/><polygon fill="#181818" points="427.5,178.9609,417.5,182.9609,427.5,186.9609,423.5,182.9609" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8" x="423.5" y="164.895">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="435.5" y="164.895">process_request(gen_keys)</text><line style="stroke:#181818;stroke-width:1.0;" x1="416.5" x2="458.5" y1="217.0938" y2="217.0938"/><line style="stroke:#181818;stroke-width:1.0;" x1="458.5" x2="458.5" y1="217.0938" y2="230.0938"/><line style="stroke:#181818;stroke-width:1.0;" x1="417.5" x2="458.5" y1="230.0938" y2="230.0938"/><polygon fill="#181818" points="427.5,226.0938,417.5,230.0938,427.5,234.0938,423.5,230.0938" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="423.5" y="212.0278">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="323" x="436.5" y="212.0278">get_sealing_key(identifier: client_pub_key+secret)</text><line style="stroke:#181818;stroke-width:1.0;" x1="416.5" x2="458.5" y1="259.2266" y2="259.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="458.5" x2="458.5" y1="259.2266" y2="272.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="417.5" x2="458.5" y1="272.2266" y2="272.2266"/><polygon fill="#181818" points="427.5,268.2266,417.5,272.2266,427.5,276.2266,423.5,272.2266" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="423.5" y="254.1606">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="436.5" y="254.1606">gen_keys(type)</text><line style="stroke:#181818;stroke-width:1.0;" x1="416.5" x2="458.5" y1="301.3594" y2="301.3594"/><line style="stroke:#181818;stroke-width:1.0;" x1="458.5" x2="458.5" y1="301.3594" y2="314.3594"/><line style="stroke:#181818;stroke-width:1.0;" x1="417.5" x2="458.5" y1="314.3594" y2="314.3594"/><polygon fill="#181818" points="427.5,310.3594,417.5,314.3594,427.5,318.3594,423.5,314.3594" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="423.5" y="296.2935">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="436.5" y="296.2935">enc(keys,seal_key)</text><line style="stroke:#181818;stroke-width:1.0;" x1="416.5" x2="458.5" y1="343.4922" y2="343.4922"/><line style="stroke:#181818;stroke-width:1.0;" x1="458.5" x2="458.5" y1="343.4922" y2="356.4922"/><line style="stroke:#181818;stroke-width:1.0;" x1="417.5" x2="458.5" y1="356.4922" y2="356.4922"/><polygon fill="#181818" points="427.5,352.4922,417.5,356.4922,427.5,360.4922,423.5,356.4922" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="423.5" y="338.4263">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="436.5" y="338.4263">sign with Enclave-signing-key</text><polygon fill="#181818" points="213.5,392.1914,203.5,396.1914,213.5,400.1914,209.5,396.1914" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="207.5" x2="405.5" y1="396.1914" y2="396.1914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="219.5" y="391.1255">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="232.5" y="391.1255">ocall_save_sealed_data()</text><path d="M5,369.4922 L5,409.4922 L198,409.4922 L198,379.4922 L188,369.4922 L5,369.4922 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M188,369.4922 L188,379.4922 L198,379.4922 L188,369.4922 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="11" y="386.5591">client_pub_key__keys</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="11" y="401.6919">client_pub_key__keys_sign</text><polygon fill="#181818" points="121,431.8906,111,435.8906,121,439.8906,117,435.8906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="115" x2="405.5" y1="435.8906" y2="435.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="127" y="430.8247">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="140" y="430.8247">return(keys)</text><!--MD5=[342e8c4be0c5a4314ec6e81b8eb08a80]
@startuml
autonumber
hide footbox
participant TrustedClient as C
participant UApp  as UH #d3d3d3
participant Eapp as E 		#87cefa

    'title Top-level Keystone SSI demo

    E-> E: ocall_wait_for_request(req)
    
        C-> E: request(gen_keys)
        activate E
        note left
        Request:
            ' id
           key type
           secret
        end note
        E -> E: process_request(gen_keys)
        activate E #DFFF00
            E -> E: get_sealing_key(identifier: client_pub_key+secret)
            E -> E: gen_keys(type)
            E -> E: enc(keys,seal_key)
            ' note right
            '     AES-GCM o ChaCha20
            ' end note
            E -> E: sign with Enclave-signing-key
            E -> UH: ocall_save_sealed_data()
            note left
                client_pub_key__keys
                client_pub_key__keys_sign
            end note
            ' note right
            '     clean secret
            ' end note
            E -> C: return(keys)
        deactivate E
    deactivate E
    ' group  STORE_VC
    '     C-> E: request(store_vc)
    '     note left
    '     Request:
    '         ' id
    '         verifiable credential
    '         secret
    '     end note
    '     E -> E: process_request(store_vc)
    '     activate E #DFFF00
    '         E -> E: get_sealing_key(identifier: client_pub_key+secret)
    '         note left
    '         same key for the same related identity
    '         end note
    '         E -> E: enc(vc,seal_key)
    '         ' note right
    '         '     AES-GCM o ChaCha20
    '         ' end note
    '         E -> E: sign with Enclave-signing-key
    '         E -> UH: ocall_save_sealed_data()
    '         ' note right
    '         '     clean secret
    '         ' end note
    '         note left
    '             client_pub_key__vc
    '             client_pub_key__vc_sign
    '         end note
    '         E -> C: return(keys)
    '     deactivate E
    ' end 

    ' group  GET_VP
    '     C-> E: request(get_vp)
    '     note left
    '     Request:
    '         ' id
    '         verifier_nonce (optional)
    '         secret
    '     end note
    '     E -> E: process_request(get_vp)
    '     activate E #DFFF00
    '         E -> E: get_sealing_key(identifier: client_pub_key+secret)
    '         note left
    '         same key for the same related identity
    '         end note
    '         E <-> UH: ocall_retrieve_sealed_data()
    '         ' note right
    '         '     clean secret
    '         ' end note
    '         note left
    '             client_pub_key__keys
    '             client_pub_key__keys_sign
    '             client_pub_key__vc
    '             client_pub_key__vc_sign
    '         end note
    '         E -> E: dec(keys,seal_key) and check sign
    '         E -> E: dec(vc,seal_key) and check sign
    '         ' note right
    '         '     AES-GCM o ChaCha20
    '         ' end note
    '         E -> E: vp = sign(vc,assertion key)
    '         E -> C: return(vp)
    '     deactivate E
    ' end
@enduml

@startuml
autonumber
hide footbox
participant TrustedClient as C
participant UApp  as UH #d3d3d3
participant Eapp as E 		#87cefa


    E-> E: ocall_wait_for_request(req)
    
        C-> E: request(gen_keys)
        activate E
        note left
        Request:
           key type
           secret
        end note
        E -> E: process_request(gen_keys)
        activate E #DFFF00
            E -> E: get_sealing_key(identifier: client_pub_key+secret)
            E -> E: gen_keys(type)
            E -> E: enc(keys,seal_key)
            E -> E: sign with Enclave-signing-key
            E -> UH: ocall_save_sealed_data()
            note left
                client_pub_key__keys
                client_pub_key__keys_sign
            end note
            E -> C: return(keys)
        deactivate E
    deactivate E

@enduml

PlantUML version 1.2022.8beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>