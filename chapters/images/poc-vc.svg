<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="428px" preserveAspectRatio="none" style="width:877px;height:428px;background:#FFFFFF;" version="1.1" viewBox="0 0 877 428" width="877px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="275.9297" style="stroke:#181818;stroke-width:1.0;" width="10" x="512.5" y="127.6953"/><rect fill="#DFFF00" height="220.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="517.5" y="182.9609"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="173" x2="173" y1="36.2969" y2="421.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="265" x2="265" y1="36.2969" y2="421.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="517" x2="517" y1="36.2969" y2="421.625"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="117" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="124" y="24.9951">TrustedClient</text><rect fill="#D3D3D3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="53" x="239" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="246" y="24.9951">UApp</text><rect fill="#87CEFA" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="51" x="492" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="499" y="24.9951">Eapp</text><rect fill="#FFFFFF" height="275.9297" style="stroke:#181818;stroke-width:1.0;" width="10" x="512.5" y="127.6953"/><rect fill="#DFFF00" height="220.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="517.5" y="182.9609"/><line style="stroke:#181818;stroke-width:1.0;" x1="517.5" x2="559.5" y1="67.4297" y2="67.4297"/><line style="stroke:#181818;stroke-width:1.0;" x1="559.5" x2="559.5" y1="67.4297" y2="80.4297"/><line style="stroke:#181818;stroke-width:1.0;" x1="518.5" x2="559.5" y1="80.4297" y2="80.4297"/><polygon fill="#181818" points="528.5,76.4297,518.5,80.4297,528.5,84.4297,524.5,80.4297" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="524.5" y="62.3638">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="537.5" y="62.3638">ocall_wait_for_request(req)</text><polygon fill="#181818" points="500.5,123.6953,510.5,127.6953,500.5,131.6953,504.5,127.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="173" x2="506.5" y1="127.6953" y2="127.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="180" y="122.6294">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="193" y="122.6294">request(store_vc)</text><path d="M5,93.4297 L5,148.4297 L168,148.4297 L168,103.4297 L158,93.4297 L5,93.4297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M158,93.4297 L158,103.4297 L168,103.4297 L158,93.4297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="11" y="110.4966">Request:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="27" y="125.6294">verifiable credential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="40" x="27" y="140.7622">secret</text><line style="stroke:#181818;stroke-width:1.0;" x1="522.5" x2="569.5" y1="169.9609" y2="169.9609"/><line style="stroke:#181818;stroke-width:1.0;" x1="569.5" x2="569.5" y1="169.9609" y2="182.9609"/><line style="stroke:#181818;stroke-width:1.0;" x1="528.5" x2="569.5" y1="182.9609" y2="182.9609"/><polygon fill="#181818" points="538.5,178.9609,528.5,182.9609,538.5,186.9609,534.5,182.9609" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8" x="534.5" y="164.895">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="546.5" y="164.895">process_request(store_vc)</text><line style="stroke:#181818;stroke-width:1.0;" x1="527.5" x2="569.5" y1="217.0938" y2="217.0938"/><line style="stroke:#181818;stroke-width:1.0;" x1="569.5" x2="569.5" y1="217.0938" y2="230.0938"/><line style="stroke:#181818;stroke-width:1.0;" x1="528.5" x2="569.5" y1="230.0938" y2="230.0938"/><polygon fill="#181818" points="538.5,226.0938,528.5,230.0938,538.5,234.0938,534.5,230.0938" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="534.5" y="212.0278">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="323" x="547.5" y="212.0278">get_sealing_key(identifier: client_pub_key+secret)</text><path d="M235,204.4609 L235,229.4609 L507,229.4609 L507,214.4609 L497,204.4609 L235,204.4609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M497,204.4609 L497,214.4609 L507,214.4609 L497,204.4609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="241" y="221.5278">same key for the same related identity</text><line style="stroke:#181818;stroke-width:1.0;" x1="527.5" x2="569.5" y1="259.2266" y2="259.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="569.5" x2="569.5" y1="259.2266" y2="272.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="528.5" x2="569.5" y1="272.2266" y2="272.2266"/><polygon fill="#181818" points="538.5,268.2266,528.5,272.2266,538.5,276.2266,534.5,272.2266" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="534.5" y="254.1606">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="547.5" y="254.1606">enc(vc,seal_key)</text><line style="stroke:#181818;stroke-width:1.0;" x1="527.5" x2="569.5" y1="301.3594" y2="301.3594"/><line style="stroke:#181818;stroke-width:1.0;" x1="569.5" x2="569.5" y1="301.3594" y2="314.3594"/><line style="stroke:#181818;stroke-width:1.0;" x1="528.5" x2="569.5" y1="314.3594" y2="314.3594"/><polygon fill="#181818" points="538.5,310.3594,528.5,314.3594,538.5,318.3594,534.5,314.3594" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="534.5" y="296.2935">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="547.5" y="296.2935">sign with Enclave-signing-key</text><polygon fill="#181818" points="276.5,342.4922,266.5,346.4922,276.5,350.4922,272.5,346.4922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="270.5" x2="516.5" y1="346.4922" y2="346.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="282.5" y="341.4263">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="295.5" y="341.4263">ocall_save_sealed_data(vc_sign)</text><path d="M102,327.3594 L102,352.3594 L260,352.3594 L260,337.3594 L250,327.3594 L102,327.3594 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M250,327.3594 L250,337.3594 L260,337.3594 L250,327.3594 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="108" y="344.4263">&lt;client_pub_key&gt;_vc</text><polygon fill="#181818" points="184,399.625,174,403.625,184,407.625,180,403.625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="178" x2="516.5" y1="403.625" y2="403.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="190" y="398.5591">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="203" y="398.5591">return(ok)</text><!--MD5=[b6936eceb2570978446e98f764270cb1]
@startuml
autonumber
hide footbox
participant TrustedClient as C
participant UApp  as UH #d3d3d3
participant Eapp as E 		#87cefa

    'title Top-level Keystone SSI demo

    E-> E: ocall_wait_for_request(req)
    
    '     C-> E: request(gen_keys)
    '     activate E
    '     note left
    '     Request:
    '         ' id
    '        key type
    '        secret
    '     end note
    '     E -> E: process_request(gen_keys)
    '     activate E #DFFF00
    '         E -> E: get_sealing_key(identifier: client_pub_key+secret)
    '         E -> E: gen_keys(type)
    '         E -> E: enc(keys,seal_key)
    '         ' note right
    '         '     AES-GCM o ChaCha20
    '         ' end note
    '         E -> E: sign with Enclave-signing-key
    '         E -> UH: ocall_save_sealed_data()
    '         note left
    '             client_pub_key__keys
    '             client_pub_key__keys_sign
    '         end note
    '         ' note right
    '         '     clean secret
    '         ' end note
    '         E -> C: return(keys)
    '     deactivate E
    ' deactivate E
    
    C-> E: request(store_vc)
    activate E
    note left
    Request:
        ' id
        verifiable credential
        secret
    end note
    E -> E: process_request(store_vc)
    activate E #DFFF00
        E -> E: get_sealing_key(identifier: client_pub_key+secret)
        note left
        same key for the same related identity
        end note
        E -> E: enc(vc,seal_key)
        ' note right
        '     AES-GCM o ChaCha20
        ' end note
        E -> E: sign with Enclave-signing-key
        E -> UH: ocall_save_sealed_data(vc_sign)
        ' note right
        '     clean secret
        ' end note
        note left
            <client_pub_key>_vc
        end note
        |||
        E -> C: return(ok)
    deactivate E
    deactivate E

        ' C-> E: request(get_vp)
        ' activate E

        ' note left
        ' Request:
        '     ' id
        '     verifier_nonce (optional)
        '     secret
        ' end note
        ' E -> E: process_request(get_vp)
        ' activate E #DFFF00
        '     E -> E: get_sealing_key(identifier: client_pub_key+secret)
        '     note left
        '     same key for the same related identity
        '     end note
        '     E <-> UH: ocall_retrieve_sealed_data()
        '     ' note right
        '     '     clean secret
        '     ' end note
        '     note left
        '         client_pub_key__keys
        '         client_pub_key__keys_sign
        '         client_pub_key__vc
        '         client_pub_key__vc_sign
        '     end note
        '     E -> E: dec(keys,seal_key) and check sign
        '     E -> E: dec(vc,seal_key) and check sign
        '     ' note right
        '     '     AES-GCM o ChaCha20
        '     ' end note
        '     E -> E: vp = sign(vc,assertion key)
        '     E -> C: return(vp)
        ' deactivate E
        ' deactivate E
@enduml

@startuml
autonumber
hide footbox
participant TrustedClient as C
participant UApp  as UH #d3d3d3
participant Eapp as E 		#87cefa


    E-> E: ocall_wait_for_request(req)
    
    
    C-> E: request(store_vc)
    activate E
    note left
    Request:
        verifiable credential
        secret
    end note
    E -> E: process_request(store_vc)
    activate E #DFFF00
        E -> E: get_sealing_key(identifier: client_pub_key+secret)
        note left
        same key for the same related identity
        end note
        E -> E: enc(vc,seal_key)
        E -> E: sign with Enclave-signing-key
        E -> UH: ocall_save_sealed_data(vc_sign)
        note left
            <client_pub_key>_vc
        end note
        |||
        E -> C: return(ok)
    deactivate E
    deactivate E


@enduml

PlantUML version 1.2022.13beta8(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>